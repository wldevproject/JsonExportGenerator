<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Export JSON ke Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      textarea {
        width: 100%;
        height: 180px;
        font-family: monospace;
        margin-bottom: 10px;
      }
      button {
        padding: 6px 12px;
        margin: 2px;
        font-size: 13px;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        white-space: pre-wrap;
        font-size: 13px;
      }
      .table-wrapper {
        max-width: 700px;
        overflow-x: auto;
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 6px;
        background-color: #fff;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        min-width: 600px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: left;
        font-size: 13px;
      }
      th {
        background-color: #f0f0f0;
        position: relative;
      }
      .copy-btn {
        cursor: pointer;
        background-color: #e0e0e0;
        border: none;
        border-radius: 4px;
        padding: 4px 6px;
      }
      .copy-btn:hover {
        background-color: #ccc;
      }
      .copy-bar {
        margin-bottom: 5px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <h2>JSON Editor â†’ Export Data Chart ke Excel</h2>

    <textarea
      id="jsonInput"
      placeholder="Tempel JSON kamu di sini..."
    ></textarea>
    <br />
    <button onclick="previewJSON()">Preview JSON</button>
    <button onclick="exportJSONToExcel()">Export ke Excel</button>

    <div id="tablePreview" class="table-wrapper"></div>

    <details style="margin-top: 20px">
      <summary><strong>Lihat Preview JSON</strong></summary>
      <pre id="jsonOutput"></pre>
    </details>

    <script>
      let parsedChartData = [];

      function previewJSON() {
        const input = document.getElementById("jsonInput").value;
        try {
          const fullJson = JSON.parse(input);
          parsedChartData = fullJson?.data?.chart || [];
          if (!Array.isArray(parsedChartData))
            throw new Error("chart bukan array");

          document.getElementById("jsonOutput").textContent = JSON.stringify(
            parsedChartData,
            null,
            2
          );
          renderTable(parsedChartData);
        } catch (e) {
          alert(
            "Format JSON tidak valid atau struktur tidak sesuai: " + e.message
          );
          parsedChartData = [];
          document.getElementById("jsonOutput").textContent = "";
          document.getElementById("tablePreview").innerHTML = "";
        }
      }

      function exportJSONToExcel() {
        if (!Array.isArray(parsedChartData) || parsedChartData.length === 0) {
          alert("Data chart kosong atau tidak valid.");
          return;
        }

        const flattened = parsedChartData.map((item) => ({
          dateTime: item.dateTime,
          harvest: item.harvest.value,
          importKwh: item.importKwh.value,
          exportKwh: item.exportKwh.value,
          energyMeterKwh: item.energyMeterKwh.value,
          harvestRatio: item.harvestRatio,
        }));

        const worksheet = XLSX.utils.json_to_sheet(flattened);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ChartData");

        XLSX.writeFile(workbook, "chart_data.xlsx");
      }

      function renderTable(data) {
        const tableContainer = document.getElementById("tablePreview");

        if (data.length === 0) {
          tableContainer.innerHTML = "<p>Data kosong</p>";
          return;
        }

        const headers = [
          "dateTime",
          "harvest",
          "importKwh",
          "exportKwh",
          "energyMeterKwh",
          "harvestRatio",
        ];

        let html = `<div class="copy-bar">
            <button class="copy-btn" onclick="copyTable()">Copy Semua</button>
          </div>
          <table><thead><tr>`;

        headers.forEach((h, index) => {
          html += `<th>
              ${h}<br />
              <button class="copy-btn" onclick="copyColumn(${index})">Copy Kolom</button>
            </th>`;
        });

        html += `</tr></thead><tbody>`;

        data.forEach((row) => {
          html += "<tr>";
          html += `<td>${row.dateTime}</td>`;
          html += `<td>${row.harvest?.value ?? ""}</td>`;
          html += `<td>${row.importKwh?.value ?? ""}</td>`;
          html += `<td>${row.exportKwh?.value ?? ""}</td>`;
          html += `<td>${row.energyMeterKwh?.value ?? ""}</td>`;
          html += `<td>${row.harvestRatio ?? ""}</td>`;
          html += "</tr>";
        });

        html += "</tbody></table>";
        tableContainer.innerHTML = html;
      }

      function copyText(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => alert("Tersalin!"))
          .catch((err) => alert("Gagal salin: " + err));
      }

      function copyTable() {
        const table = document.querySelector("#tablePreview table");
        if (!table) return;

        let text = "";
        for (const row of table.rows) {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            rowData.push(row.cells[i].innerText);
          }
          text += rowData.join("\t") + "\n";
        }

        copyText(text.trim());
      }

      function copyColumn(index) {
        const table = document.querySelector("#tablePreview table");
        if (!table) return;

        let columnText = "";
        for (let i = 1; i < table.rows.length; i++) {
          const cell = table.rows[i].cells[index];
          if (cell) columnText += cell.innerText + "\n";
        }

        copyText(columnText.trim());
      }
    </script>
  </body>
</html>
