<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Excel ke JSON → Format Data Chart</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      textarea {
        width: 100%;
        height: 160px;
        font-family: monospace;
        margin-bottom: 10px;
      }
      button {
        padding: 6px 12px;
        margin: 2px;
        font-size: 13px;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        white-space: pre-wrap;
        font-size: 13px;
      }
      .table-wrapper {
        max-width: 700px;
        overflow-x: auto;
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 6px;
        background-color: #fff;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        min-width: 600px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 6px;
        text-align: left;
        font-size: 13px;
      }
      th {
        background-color: #f0f0f0;
        position: relative;
      }
      .copy-btn {
        cursor: pointer;
        background-color: #e0e0e0;
        border: none;
        border-radius: 4px;
        padding: 4px 6px;
      }
      .copy-btn:hover {
        background-color: #ccc;
      }
      .copy-bar {
        margin-bottom: 5px;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <h2>Tempel Data Excel → Konversi ke Format JSON Chart</h2>
    <textarea
      id="excelInput"
      placeholder="Paste data dari Excel di sini..."
    ></textarea>
    <br />
    <button onclick="convertToJSON()">Konversi ke JSON</button>

    <div id="tablePreview" class="table-wrapper"></div>

    <details style="margin-top: 20px">
      <summary><strong>Lihat Hasil JSON</strong></summary>
      <pre id="jsonOutput"></pre>
    </details>

    <script>
      function convertToJSON() {
        const input = document.getElementById("excelInput").value.trim();
        if (!input) return alert("Data kosong!");

        const lines = input.split(/\n|\r/).filter((line) => line.trim());
        const data = lines.map((line) => line.split(/\t|\s{2,}/));

        const result = [];
        for (const row of data) {
          const [dateTime, harvest, importKwh, exportKwh] = row;
          if (!dateTime || isNaN(harvest) || isNaN(importKwh)) continue;

          const h = parseFloat(harvest);
          const imp = parseFloat(importKwh);
          const exp = parseFloat(exportKwh ?? 0);
          const meter = imp - exp + h;

          result.push({
            dateTime: dateTime,
            harvest: { value: h, unit: "kWh" },
            importKwh: { value: imp, unit: "kWh" },
            exportKwh: { value: exp, unit: "kWh" },
            energyMeterKwh: { value: meter, unit: "kWh" },
            harvestRatio: meter > 0 ? parseFloat((h / meter).toFixed(3)) : 0,
          });
        }

        const fullJSON = { data: { chart: result } };

        document.getElementById("jsonOutput").textContent = JSON.stringify(
          fullJSON,
          null,
          2
        );

        renderTable(result);
      }

      function renderTable(data) {
        const tableContainer = document.getElementById("tablePreview");

        if (data.length === 0) {
          tableContainer.innerHTML = "<p>Data kosong</p>";
          return;
        }

        const headers = [
          "dateTime",
          "harvest",
          "importKwh",
          "exportKwh",
          "energyMeterKwh",
          "harvestRatio",
        ];

        let html = `<div class="copy-bar">
            <button class="copy-btn" onclick="copyTable()">Copy Semua</button>
          </div>
          <table><thead><tr>`;

        headers.forEach((h, index) => {
          html += `<th>
              ${h}<br />
              <button class="copy-btn" onclick="copyColumn(${index})">Copy Kolom</button>
            </th>`;
        });

        html += `</tr></thead><tbody>`;

        data.forEach((row) => {
          html += "<tr>";
          html += `<td>${row.dateTime}</td>`;
          html += `<td>${row.harvest?.value ?? ""}</td>`;
          html += `<td>${row.importKwh?.value ?? ""}</td>`;
          html += `<td>${row.exportKwh?.value ?? ""}</td>`;
          html += `<td>${row.energyMeterKwh?.value ?? ""}</td>`;
          html += `<td>${row.harvestRatio ?? ""}</td>`;
          html += "</tr>";
        });

        html += "</tbody></table>";
        tableContainer.innerHTML = html;
      }

      function copyText(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => alert("Tersalin!"))
          .catch((err) => alert("Gagal salin: " + err));
      }

      function copyTable() {
        const table = document.querySelector("#tablePreview table");
        if (!table) return;

        let text = "";
        for (const row of table.rows) {
          const rowData = [];
          for (let i = 0; i < row.cells.length; i++) {
            rowData.push(row.cells[i].innerText);
          }
          text += rowData.join("\t") + "\n";
        }

        copyText(text.trim());
      }

      function copyColumn(index) {
        const table = document.querySelector("#tablePreview table");
        if (!table) return;

        let columnText = "";
        for (let i = 1; i < table.rows.length; i++) {
          const cell = table.rows[i].cells[index];
          if (cell) columnText += cell.innerText + "\n";
        }

        copyText(columnText.trim());
      }
    </script>
  </body>
</html>
